import{_ as Q,u as Y,r as w,c as B,o as Z,W as ee,b as M,A as te,B as ae,h as N,e as u,w as y,d as m,F as U,l as V,n as D,f as s,g as _,i as E,k as c,I as h,t as o,v as C}from"./index-naspanel.js";const se={class:"widget-header"},re={class:"header-main"},oe={class:"header-icon"},ne={class:"header-title"},le={class:"update-time"},ie={class:"header-sub"},ce={class:"hostname"},ue={key:0,class:"widget-content"},de={class:"label"},me={key:0},_e={key:1},he={class:"value"},pe={class:"disk-stats"},ve={key:1,class:"empty-state"},fe={name:"SmartWidget",displayName:"Status SMART"},Se=Object.assign(fe,{setup(ge,{expose:L}){const{t:l}=Y(),d=w([]),T=w(!1),I=w(l("common.loading")),$=50,W=55;let p=null;const g=w(new Set),O={OK:l("common.yes"),ERROR:l("common.error"),BAD_SECTORS:l("storageSmart.statusValues.badSectors")},j=B(()=>d.value.some(t=>!t.status||t.badSectors>0||t.outOfSpecParams.length>0||b(t.temperature,t.isSSD))?"danger":"success"),k=B(()=>{const e=d.value.filter(t=>!t.status||t.badSectors>0||t.outOfSpecParams.length>0||b(t.temperature,t.isSSD)).length;return e?`${e} ${l("common.errors")}`:l("common.allOk")}),F=e=>e.includes("nvme")?"ph:hard-drive":"ph:hard-drives",K=e=>e.split("/").pop().toUpperCase(),b=(e,t=!1)=>e?e>(t?$:W):!1,R=e=>e.badSectors>0||e.outOfSpecParams.length>0||b(e.temperature,e.isSSD),q=e=>e.status?e.badSectors>0?"bad-sectors":R(e)?"warning":"ok":"error",z=e=>e.badSectors>0?O.BAD_SECTORS:e.status?O.OK:O.ERROR,H=async e=>{const t=new AbortController;g.value.add(t);try{const a=(await C.get(`/api/storage/smart/details/${encodeURIComponent(e)}`,{timeout:8e3,signal:t.signal})).data?.data||{},v=a.rotation_rate===0;let r=0;if(a.ata_smart_attributes?.table){const n=a.ata_smart_attributes.table.find(S=>S.id===5),G=a.ata_smart_attributes.table.find(S=>S.id===197),J=a.ata_smart_attributes.table.find(S=>S.id===198);r=(n?.raw?.value||0)+(G?.raw?.value||0)+(J?.raw?.value||0)}const f=[];return a.ata_smart_attributes?.table&&a.ata_smart_attributes.table.forEach(n=>{n.value&&n.thresh&&n.value<=n.thresh&&f.push({id:n.id,name:n.name,value:n.value,threshold:n.thresh})}),{device:e,status:a.smart_status?.passed||!1,temperature:a.temperature?.current||X(a),isSSD:v,badSectors:r,outOfSpecParams:f,rawData:a}}catch(i){return C.isCancel(i)||console.error(`Error fetching ${e} details:`,i),{device:e,status:!1,temperature:null,isSSD:!1,badSectors:0,outOfSpecParams:[],rawData:null}}finally{g.value.delete(t)}},X=e=>{if(!e)return null;if(e.nvme_smart_health_information_log?.temperature)return e.nvme_smart_health_information_log.temperature-273;if(e.temperature?.current)return e.temperature.current;if(e.ata_smart_attributes?.table){const t=e.ata_smart_attributes.table.find(i=>["Temperature_Celsius","Temperature_Internal"].includes(i.name)||i.id===194);if(t?.raw?.value)return parseInt(t.raw.value)}return null},x=()=>{g.value.forEach(e=>{e.abort()}),g.value.clear()},P=async()=>{x(),T.value=!0,d.value=[];try{const t=(await C.get("/api/storage/smart/monitoring",{timeout:5e3})).data.devices||{},i=Object.keys(t).filter(a=>t[a]?.monitored===!0);i.length;for(let a=0;a<i.length;a+=2){const v=i.slice(a,a+2),r=await Promise.all(v.map(f=>H(f)));d.value.push(...r)}I.value=new Date().toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}catch(e){C.isCancel(e)||(console.error("Error:",e),I.value=l("common.error")),d.value=[]}finally{T.value=!1}},A=async()=>{await P()};return L({refreshData:A}),Z(()=>{p&&clearInterval(p),P().finally(()=>{p=setInterval(()=>{document.visibilityState==="visible"&&A()},3e4)})}),ee(()=>{x(),p&&clearInterval(p)}),(e,t)=>{const i=M("el-tooltip"),a=M("el-card"),v=te("loading");return ae((u(),N(a,{class:"widget-card",shadow:"hover"},{header:y(()=>[s("div",se,[s("div",re,[s("div",oe,[_(c(h),{icon:"ph:hard-drives",width:"16"})]),s("span",ne,o(c(l)("storageSmart.title")),1),s("div",le,[_(c(h),{icon:"mdi:update",width:"12"}),s("span",null,o(c(l)("common.update"))+": "+o(I.value),1)])]),s("div",ie,[s("span",ce,o(k.value),1),s("span",{class:D(["system",j.value])},o(d.value.length)+" "+o(c(l)("storageSmart.disks")),3)])])]),default:y(()=>[d.value.length>0?(u(),m("div",ue,[(u(!0),m(U,null,V(d.value,(r,f)=>(u(),m("div",{key:r.device,class:D(["info-row disk-item",{"warning-row":R(r)}])},[s("div",de,[_(c(h),{icon:F(r.device),width:"14"},null,8,["icon"]),s("span",null,o(K(r.device)),1),R(r)?(u(),N(i,{key:0,effect:"dark",placement:"top"},{content:y(()=>[r.badSectors>0?(u(),m("div",me,[s("p",null,o(c(l)("storageSmart.statusValues.badSectors"))+": "+o(r.badSectors),1)])):E("",!0),r.outOfSpecParams.length>0?(u(),m("div",_e,[s("p",null,o(c(l)("storageSmart.details.outOfSpec"))+":",1),s("ul",null,[(u(!0),m(U,null,V(r.outOfSpecParams,n=>(u(),m("li",{key:n.id},o(n.name)+": "+o(n.value)+" ("+o(c(l)("storageSmart.details.threshold"))+": "+o(n.threshold)+") ",1))),128))])])):E("",!0)]),default:y(()=>[_(c(h),{icon:"ph:warning",width:"12",class:"warning-icon"})]),_:2},1024)):E("",!0)]),s("div",he,[s("div",pe,[s("div",{class:D(["temperature",{critical:b(r.temperature,r.isSSD)}])},[_(c(h),{icon:"mdi:thermometer",width:"12"}),s("span",null,o(r.temperature||"--")+"Â°C",1)],2),s("div",{class:D(["status",q(r)])},o(z(r)),3)])])],2))),128))])):(u(),m("div",ve,[_(c(h),{icon:"ph:info",width:"16"}),s("span",null,o(c(l)("storageSmart.notAvailableMessage")),1)]))]),_:1})),[[v,T.value]])}}}),we=Q(Se,[["__scopeId","data-v-1bdd7b32"]]);export{we as default};

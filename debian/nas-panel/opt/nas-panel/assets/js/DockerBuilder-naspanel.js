import{_ as ee,r as u,c as le,o as te,b as p,A as ae,d as oe,e as q,f as v,B as se,g as l,w as a,k as b,I as _,m,h as re,t as L,v as y,x as d,C as ne}from"./index-naspanel.js";const ue={class:"docker-builder"},ie={class:"header"},de={class:"actions"},ce={class:"logs-content"},pe={class:"logs-header"},me={class:"logs-output"},fe={class:"progress-content"},ve={class:"progress-logs"},ge={__name:"DockerBuilder",setup(be){const $=u([]),I=u(!1),w=u(""),C=u(!1),B=u(!1),D=u(!1),g=u(!1),h=u(""),k=u(""),V=u(0),F=u(""),S=u(""),P=u(""),r=u({name:"",tag:"latest",dockerfile:"",files:[]}),n=u({url:"",branch:"main",dockerfilePath:"Dockerfile",name:"",tag:"latest"}),G=le(()=>{if(!w.value)return $.value;const o=w.value.toLowerCase();return $.value.filter(e=>e.name.toLowerCase().includes(o)||e.tag.toLowerCase().includes(o)||e.status.toLowerCase().includes(o))}),H=o=>({success:"success",building:"warning",error:"danger",pending:"info"})[o]||"info",x=async()=>{try{I.value=!0;const o=await y.get("/services/docker/builds");$.value=o.data.builds}catch(o){d.error("Failed to fetch builds"),console.error(o)}finally{I.value=!1}},R=(o,e)=>{r.value.files=e},z=async()=>{try{if(!r.value.name||!r.value.dockerfile){d.warning("Please provide build name and Dockerfile content");return}S.value=r.value.name,g.value=!0,k.value=`Starting build...
`,V.value=0,F.value="";const o=new FormData;o.append("name",r.value.name),o.append("tag",r.value.tag),o.append("dockerfile",r.value.dockerfile),r.value.files.forEach((s,c)=>{o.append(`file${c}`,s.raw)});const i=(await y.post("/services/docker/build",o,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:s=>{const c=Math.round(s.loaded*100/s.total);V.value=c,k.value+=`Upload progress: ${c}%
`}})).data.buildId;T(i)}catch(o){d.error("Failed to start build"),console.error(o),g.value=!1}},T=async o=>{try{const e=new EventSource(`${window.location.protocol}//${window.location.hostname}:1112/services/docker/build/${o}/progress`);e.onmessage=i=>{const s=JSON.parse(i.data);s.log&&(k.value+=s.log+`
`),s.progress&&(V.value=s.progress),s.status&&(F.value=s.status,(s.status==="success"||s.status==="error")&&(e.close(),setTimeout(()=>{g.value=!1,x()},2e3)))},e.onerror=()=>{e.close(),g.value=!1,d.error("Build monitoring failed")}}catch(e){console.error("Build monitoring error:",e)}},E=async()=>{try{if(!n.value.url||!n.value.name){d.warning("Please provide GitHub URL and image name");return}S.value=n.value.name,g.value=!0,k.value=`Starting import from GitHub...
`,V.value=0;const e=(await y.post("/services/docker/build/github",n.value)).data.buildId;T(e)}catch(o){d.error("Failed to import from GitHub"),console.error(o),g.value=!1}},O=async o=>{try{await y.post("/services/docker/container/create",{name:o.replace(":","-"),image:o}),d.success("Container created successfully")}catch(e){d.error("Failed to create container"),console.error(e)}},A=async o=>{try{await ne.confirm(`Delete image "${o}"?`,"Warning",{confirmButtonText:"Delete",cancelButtonText:"Cancel",type:"warning"}),await y.delete("/services/docker/images/remove",{params:{image:o}}),d.success("Image deleted successfully"),await x()}catch(e){e!=="cancel"&&(d.error("Failed to delete image"),console.error(e))}},W=async o=>{try{P.value=o;const e=await y.get(`/services/docker/build/${o}/logs`);h.value=e.data.logs,D.value=!0}catch(e){d.error("Failed to get build logs"),console.error(e)}},J=()=>{navigator.clipboard.writeText(h.value).then(()=>d.success("Logs copied to clipboard")).catch(()=>d.error("Failed to copy logs"))};return te(()=>{x()}),(o,e)=>{const i=p("el-input"),s=p("el-button"),c=p("el-table-column"),K=p("el-tag"),Q=p("el-button-group"),Y=p("el-table"),f=p("el-form-item"),j=p("el-upload"),M=p("el-form"),U=p("el-dialog"),X=p("el-progress"),Z=ae("loading");return q(),oe("div",ue,[v("div",ie,[l(i,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=t=>w.value=t),placeholder:"Search builds...",clearable:"",style:{width:"300px"}},{prefix:a(()=>[l(b(_),{icon:"mdi:magnify"})]),_:1},8,["modelValue"]),v("div",de,[l(s,{type:"primary",onClick:x},{default:a(()=>[l(b(_),{icon:"mdi:refresh",class:"icon"}),e[18]||(e[18]=m(" Refresh "))]),_:1,__:[18]}),l(s,{type:"success",onClick:e[1]||(e[1]=t=>C.value=!0)},{default:a(()=>[l(b(_),{icon:"mdi:plus",class:"icon"}),e[19]||(e[19]=m(" New Build "))]),_:1,__:[19]}),l(s,{type:"info",onClick:e[2]||(e[2]=t=>B.value=!0)},{default:a(()=>[l(b(_),{icon:"mdi:github",class:"icon"}),e[20]||(e[20]=m(" Import from GitHub "))]),_:1,__:[20]})])]),se((q(),re(Y,{data:G.value,style:{width:"100%"},stripe:""},{default:a(()=>[l(c,{prop:"name",label:"Build Name"}),l(c,{prop:"tag",label:"Tag",width:"120"}),l(c,{prop:"status",label:"Status",width:"120"},{default:a(({row:t})=>[l(K,{type:H(t.status),size:"small"},{default:a(()=>[m(L(t.status),1)]),_:2},1032,["type"])]),_:1}),l(c,{prop:"created",label:"Created",width:"180"}),l(c,{prop:"size",label:"Size",width:"100"}),l(c,{label:"Actions",width:"200"},{default:a(({row:t})=>[l(Q,null,{default:a(()=>[l(s,{size:"small",type:"primary",onClick:N=>O(t.name+":"+t.tag),disabled:t.status!=="success"},{default:a(()=>[l(b(_),{icon:"mdi:play"})]),_:2},1032,["onClick","disabled"]),l(s,{size:"small",type:"danger",onClick:N=>A(t.name+":"+t.tag)},{default:a(()=>[l(b(_),{icon:"mdi:delete"})]),_:2},1032,["onClick"]),l(s,{size:"small",type:"info",onClick:N=>W(t.buildId)},{default:a(()=>[l(b(_),{icon:"mdi:file-document"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Z,I.value]]),l(U,{modelValue:C.value,"onUpdate:modelValue":e[7]||(e[7]=t=>C.value=t),title:"Create Docker Build",width:"800px"},{footer:a(()=>[l(s,{onClick:e[6]||(e[6]=t=>C.value=!1)},{default:a(()=>e[23]||(e[23]=[m("Cancel")])),_:1,__:[23]}),l(s,{type:"primary",onClick:z},{default:a(()=>e[24]||(e[24]=[m("Start Build")])),_:1,__:[24]})]),default:a(()=>[l(M,{model:r.value,"label-width":"120px"},{default:a(()=>[l(f,{label:"Build Name",required:""},{default:a(()=>[l(i,{modelValue:r.value.name,"onUpdate:modelValue":e[3]||(e[3]=t=>r.value.name=t),placeholder:"my-app"},null,8,["modelValue"])]),_:1}),l(f,{label:"Tag",required:""},{default:a(()=>[l(i,{modelValue:r.value.tag,"onUpdate:modelValue":e[4]||(e[4]=t=>r.value.tag=t),placeholder:"latest"},null,8,["modelValue"])]),_:1}),l(f,{label:"Dockerfile Content",required:""},{default:a(()=>[l(i,{modelValue:r.value.dockerfile,"onUpdate:modelValue":e[5]||(e[5]=t=>r.value.dockerfile=t),type:"textarea",rows:15,placeholder:`FROM node:18
WORKDIR /app
COPY . .
RUN npm install
CMD ["npm", "start"]`},null,8,["modelValue"])]),_:1}),l(f,{label:"Build Context"},{default:a(()=>[l(j,{action:"#","auto-upload":!1,"on-change":R,"file-list":r.value.files,multiple:""},{tip:a(()=>e[22]||(e[22]=[v("div",{class:"el-upload__tip"},"Select additional files needed for build",-1)])),default:a(()=>[l(s,{type:"primary"},{default:a(()=>e[21]||(e[21]=[m("Select Build Files")])),_:1,__:[21]})]),_:1},8,["file-list"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(U,{modelValue:B.value,"onUpdate:modelValue":e[14]||(e[14]=t=>B.value=t),title:"Import from GitHub",width:"600px"},{footer:a(()=>[l(s,{onClick:e[13]||(e[13]=t=>B.value=!1)},{default:a(()=>e[25]||(e[25]=[m("Cancel")])),_:1,__:[25]}),l(s,{type:"primary",onClick:E},{default:a(()=>e[26]||(e[26]=[m("Import & Build")])),_:1,__:[26]})]),default:a(()=>[l(M,{model:n.value,"label-width":"120px"},{default:a(()=>[l(f,{label:"GitHub URL",required:""},{default:a(()=>[l(i,{modelValue:n.value.url,"onUpdate:modelValue":e[8]||(e[8]=t=>n.value.url=t),placeholder:"https://github.com/user/repo"},null,8,["modelValue"])]),_:1}),l(f,{label:"Branch"},{default:a(()=>[l(i,{modelValue:n.value.branch,"onUpdate:modelValue":e[9]||(e[9]=t=>n.value.branch=t),placeholder:"main"},null,8,["modelValue"])]),_:1}),l(f,{label:"Dockerfile Path"},{default:a(()=>[l(i,{modelValue:n.value.dockerfilePath,"onUpdate:modelValue":e[10]||(e[10]=t=>n.value.dockerfilePath=t),placeholder:"Dockerfile"},null,8,["modelValue"])]),_:1}),l(f,{label:"Image Name",required:""},{default:a(()=>[l(i,{modelValue:n.value.name,"onUpdate:modelValue":e[11]||(e[11]=t=>n.value.name=t),placeholder:"my-app"},null,8,["modelValue"])]),_:1}),l(f,{label:"Tag",required:""},{default:a(()=>[l(i,{modelValue:n.value.tag,"onUpdate:modelValue":e[12]||(e[12]=t=>n.value.tag=t),placeholder:"latest"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(U,{modelValue:D.value,"onUpdate:modelValue":e[16]||(e[16]=t=>D.value=t),title:`Build Logs: ${P.value}`,width:"80%"},{footer:a(()=>[l(s,{onClick:e[15]||(e[15]=t=>D.value=!1)},{default:a(()=>e[28]||(e[28]=[m("Close")])),_:1,__:[28]})]),default:a(()=>[v("div",ce,[v("div",pe,[l(s,{onClick:J,type:"",class:"copy-btn"},{default:a(()=>[l(b(_),{icon:"mdi:content-copy"}),e[27]||(e[27]=m(" Copy "))]),_:1,__:[27]})]),v("pre",me,L(h.value),1)])]),_:1},8,["modelValue","title"]),l(U,{modelValue:g.value,"onUpdate:modelValue":e[17]||(e[17]=t=>g.value=t),title:`Building: ${S.value}`,width:"80%"},{default:a(()=>[v("div",fe,[l(X,{percentage:V.value,status:F.value},null,8,["percentage","status"]),v("div",ve,[v("pre",null,L(k.value),1)])])]),_:1},8,["modelValue","title"])])}}},ye=ee(ge,[["__scopeId","data-v-798c5b50"]]);export{ye as default};

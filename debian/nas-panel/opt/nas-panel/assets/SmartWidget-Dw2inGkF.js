import{_ as N,r as d,c as T,o as W,K,h as c,f as D,b as f,w as _,a as V,e as p,d as h,j as k,I as P,l as $,t as H,y as v}from"./index-BdZFAIpY.js";import{P as L}from"./es6-promise-pool-D2trsFJJ.js";const U={class:"widget-header"},Y={key:2,class:"empty-state"},q={name:"SmartWidget",displayName:"Status SMART"},z=Object.assign(q,{setup(F,{expose:x}){const n=d([]),m=d(!1),C=50,E=55;let l=null;const g=T(()=>n.value.some(e=>!e.status||e.badSectors>0||e.outOfSpecParams.length>0||b(e.temperature,e.isSSD))?"danger":"success"),O=T(()=>{const t=n.value.filter(e=>!e.status||e.badSectors>0||e.outOfSpecParams.length>0||b(e.temperature,e.isSSD)).length;return t?`${t} BŁĘDY`:"WSZYSTKO OK"}),b=(t,e=!1)=>t?t>(e?C:E):!1,u=d(new Set),B=async t=>{const e=new AbortController,r=setTimeout(()=>e.abort(),8e3);u.value.add(e);try{const a=(await v.get(`/api/storage/smart/details/${encodeURIComponent(t)}`,{timeout:5e3,signal:e.signal})).data.data,R=a.rotation_rate===0;let y=0;if(a.ata_smart_attributes?.table){const o=a.ata_smart_attributes.table.find(i=>i.id===5),j=a.ata_smart_attributes.table.find(i=>i.id===197),A=a.ata_smart_attributes.table.find(i=>i.id===198);y=(o?.raw?.value||0)+(j?.raw?.value||0)+(A?.raw?.value||0)}const I=[];return a.ata_smart_attributes?.table&&a.ata_smart_attributes.table.forEach(o=>{o.value&&o.thresh&&o.value<=o.thresh&&I.push({id:o.id,name:o.name,value:o.value,threshold:o.thresh})}),{device:t,status:a.smart_status?.passed||!1,temperature:a.temperature?.current||M(a),isSSD:R,badSectors:y,outOfSpecParams:I,rawData:a}}catch(s){return v.isCancel(s)||console.error(`Error fetching ${t} details:`,s),{device:t,status:!1,temperature:null,isSSD:!1,badSectors:0,outOfSpecParams:[],rawData:null}}finally{clearTimeout(r),u.value.delete(e)}},M=t=>{if(t.nvme_smart_health_information_log?.temperature)return t.nvme_smart_health_information_log.temperature-273;if(t.temperature?.current)return t.temperature.current;if(t.ata_smart_attributes?.table){const e=t.ata_smart_attributes.table.find(r=>["Temperature_Celsius","Temperature_Internal"].includes(r.name)||r.id===194);if(e?.raw?.value)return parseInt(e.raw.value)}return null},w=()=>{u.value.forEach(t=>{t.abort()}),u.value.clear()},S=async()=>{w(),m.value=!0;try{const t=await v.get("/api/storage/smart/monitoring",{timeout:1e4}),e=Object.keys(t.data.devices).filter(s=>t.data.devices[s].monitored),r=new L(()=>e.length?B(e.shift()):null,2);n.value=[];for await(const s of r)s&&n.value.push(s)}catch(t){console.error("Fetch error:",t),n.value=[]}finally{m.value=!1}};return x({refreshData:async()=>{await S()}}),W(()=>{l&&clearInterval(l);const t=async()=>{try{await S()}catch(e){console.error("Interval fetch error:",e),await new Promise(r=>setTimeout(r,5e3))}};t(),l=setInterval(t,15e3)}),K(()=>{w(),l&&clearInterval(l)}),(t,e)=>{const r=c("el-tag"),s=c("el-skeleton");c("el-tooltip"),c("el-divider");const a=c("el-card");return f(),D(a,{class:"widget-card",shadow:"hover"},{header:_(()=>[h("div",U,[p(k(P),{icon:"ph:hard-drives",width:"18"}),e[0]||(e[0]=h("span",{class:"widget-title"},"Monitorowane dyski",-1)),p(r,{type:g.value,size:"small",effect:g.value==="danger"?"dark":"plain",round:""},{default:_(()=>[$(H(O.value),1)]),_:1},8,["type","effect"])])]),default:_(()=>[m.value?(f(),D(s,{key:0,rows:3,animated:""})):(f(),V("div",Y,[p(k(P),{icon:"ph:info",width:"16"}),e[2]||(e[2]=h("span",null,"Brak dysków objętych monitoringiem",-1))]))]),_:1})}}}),Q=N(z,[["__scopeId","data-v-8a72d269"]]);export{Q as default};
